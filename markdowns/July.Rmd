---
title: "July"
author: "Andrea Odell"
date: "6/30/2021"
output:
  pdf_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/andrea/Box/UC DAVIS/Oken Lab/lingcod-rockfish")
```

### July 1, 2021

This week, I did a literature search on "Conditional age-at-length" (CAAL) and was pretty unsuccessful. Much of the literature spoke about integrated stock assessments and estimating CAAL within the stock assessment as opposed to estimating through data externally and using those fixed estimates in stock assessments. I felt like what I was finding wasn't relevant to what I needed since I'm just trying to estimate the growth curve parameters to predict missing ages in the dataset. The CAAL search came about when I mentioned that there may have been a downward bias in the predicted ages compared to observed ages. This was a quick observation I had made based on the data that I saw, but of course I didn't see everything, so I went back to check if my observation was correct by determining the proportion of predictions that underestimated, overestimated, and correctly estimated.

```{r length bias, echo = FALSE, message = FALSE}
library(tidyverse)
load("cleaned_data/lingcod_rockfish.Rdata")
load("cleaned_data/lingcod_full_with_age.Rdata")

lingcod_age_comparison <- lingcod_full_with_age %>% 
  select(Ages, age_pred)

predicted_smaller = lingcod_age_comparison$Ages > lingcod_age_comparison$age_pred
predicted_smaller <- predicted_smaller[!is.na(predicted_smaller)]
underestimated = sum(predicted_smaller) #296 underestimated

predicted_bigger = lingcod_age_comparison$Ages < lingcod_age_comparison$age_pred
predicted_bigger <- predicted_bigger[!is.na(predicted_bigger)]
overestimated = sum(predicted_bigger) #522 overestimated

predicted_same = lingcod_age_comparison$Ages == lingcod_age_comparison$age_pred
predicted_same <- predicted_same[!is.na(predicted_same)]
estimated_well = sum(predicted_same) # 313 estimated well

total_estimated = underestimated + overestimated + estimated_well
underestimated/total_estimated
overestimated/total_estimated
estimated_well/total_estimated
```

There wasn't much difference in these numbers between male and female, so no sex-related bias. Looking at the estimated growth curve over the observed data for males and females, it may be that the older ages are being underestimated and the younger ages are being overestimated. I am using the francis parameterization, which may not be the best way to model the growth for this dataset. So I can try other parameterizations. I think I was using the francis parameterization because I was trying to use a package originally, and it was the only one that would work. But then I ended up not using the package anyway and I guess I just stuck with that one. Kiva response: This is fine. The parameterizations are meant to avoid the issue that K and Linf are negatively correlated.

I currently have a subset of the data with stomach contents. I've asked Bonnie to send me the rest of the data (empty stomachs) so that I have more data points for the length-age predictions.

```{r VBGF, echo = FALSE, message = FALSE, eval = FALSE}
# MALES
ages_francis_male <- c(3,11) # male t1 and t3 age
male_TL_aget1 = lingcod_rockfish %>% # Filter out all male age at t1
  filter(Sex.1 == "M", Ages == ages_francis_male[1]) %>% 
  select(TL.cm)
male_TL_aget2 = lingcod_rockfish %>% # Filter out all male at t2
  filter(Sex.1 == "M", Ages == mean(ages_francis_male)) %>% 
  select(TL.cm)
male_TL_aget3 = lingcod_rockfish %>% # Filter out all male at t3
  filter(Sex.1 == "M", Ages == ages_francis_male[2]) %>% 
  select(TL.cm)
L1_m <- mean(male_TL_aget1$TL.cm) # mean length at relatively young age t1 (age 3 used here)
L2_m <- mean(male_TL_aget2$TL.cm) # mean length at the average of t1 and t2 (age 7 used here)
L3_m <- mean(male_TL_aget3$TL.cm) # mean length at relatively old age t2 (age 11 used here)
r_m <- (L3_m-L2_m)/(L2_m-L1_m)

predict_age_m <- function(length) { # Function that predicts male age given length
  if(length >= 93) { # I chose this length because that's when the predicted age goes above 20
    pred_age <-  20 # set max age to 20
  } else {
    pred_age <- ages_francis_male[1] + (ages_francis_male[2]-ages_francis_male[1])*((log(1-(1-r_m^2)*((length-L1_m)/(L3_m-L1_m))))/(2*log(r_m)))
  }
  return(pred_age) 
}

# FEMALES
ages_francis_female <- c(3,15)
female_TL_aget1 = lingcod_rockfish %>% # Filter out all female age at t1
  filter(Sex.1 == "F", Ages == ages_francis_female[1]) %>% 
  select(TL.cm)
female_TL_aget2 = lingcod_rockfish %>% # Filter out all female age at t2
  filter(Sex.1 == "F", Ages == mean(ages_francis_female)) %>% 
  select(TL.cm)
female_TL_aget3 = lingcod_rockfish %>% # Filter out all female age at t2
  filter(Sex.1 == "F", Ages == ages_francis_female[2]) %>% 
  select(TL.cm)
L1_f <- mean(female_TL_aget1$TL.cm)  # mean length at relatively young age t1 (age 3 used here)
L2_f <- mean(female_TL_aget2$TL.cm)  # mean length at the average of t1 and t2 (age 9 used here)
L3_f <- mean(female_TL_aget3$TL.cm) # mean length at relatively old age t2 (age 15 used here)
r_f <- (L3_f-L2_f)/(L2_f-L1_f)

predict_age_f <- function(length) {
  if(length >= 117) {
    pred_age <-  20
  } else {
    pred_age <- ages_francis_female[1] + (ages_francis_female[2]-ages_francis_female[1])*((log(1-(1-r_f^2)*((length-L1_f)/(L3_f-L1_f))))/(2*log(r_f)))
  }
  return(pred_age) 
}

# this helps prevent the warning messages.
v_predict_age_m <- Vectorize(predict_age_m)
v_predict_age_f <- Vectorize(predict_age_f)
```

```{r growthplots, echo = FALSE, eval = FALSE}
lingcod_male <- lingcod_rockfish %>% 
  filter(Sex.1 == "M")
lingcod_female <- lingcod_rockfish %>% 
  filter(Sex.1 == "F")

#males
predicted_age_m = sapply(1:120, predict_age_m)
predicted_age_m = pmax(predicted_age_m, 0)
predicted_age_m = as.data.frame(predicted_age_m) %>% 
  mutate(length = 1:120)
#females
predicted_age_f = sapply(1:120, predict_age_f)
predicted_age_f = pmax(predicted_age_f, 0)
predicted_age_f = as.data.frame(predicted_age_f) %>% 
  mutate(length = 1:120)

plot(lingcod_female$Ages, lingcod_female$TL.cm, type = "p", xlab = "Ages", ylab = "Length (cm)", main = "female", ylim = c(0,120))
lines(predicted_age_f$predicted_age_f, predicted_age_f$length)

plot(lingcod_male$Ages, lingcod_male$TL.cm, type = "p", xlab = "Ages", ylab = "Length (cm)", main = "male", ylim = c(0,100))
lines(predicted_age_m$predicted_age_m, predicted_age_m$length)
```

During my literacture search, however, I did find a paper that uses Bayesian length-at-age models to estimate the growth curve parameters. So, I think I'll give it a shot... (if you think its worth it). One thing that it mentioned (of the small bit that I've read of the paper so far) is that the use of priors on information of min and max lengths can help a lot when there's limited data for those sizes in your dataset. So, I can pull that information from the lingcod stock assessment. BUT there are some discrepancies it seems like ...

##### Notes-

$L\infty = 131 cm$ for females and $L\infty= 93 cm$ for males sampled off of British Columbia (Richards et al. 1990).\
Upon hatching, the larvae are about 12 mm in total length and become epipelagic. 70-80 mm at about 3 months of age.\
Externally estimated growth parameters using the 2003-2015 WCBTS is $k=0.191$ and $L\infty=100.9$ (female) and $k=0.214$ and $L\infty=86.3$ (male) for the south. Internally estimate growth curves for south (CA) are shown in figure 41\
![Figure 41 from 2017 lingcod stock assessment](July_images/lingcod_south_growthcurve_stockassess.png){height="50%"}

So, it seems like the external estimates and my own visualization of the internally estimate growth curve above do not correspond to each other well. How come? Obviously data are different, but should it really make that much of a difference if we're trying to estimate the same populations? The internally estimated growth curve looks less like Bonnie's data than the externally estimated parameters. Kiva response: the way the model is structured might affect the estimates, especially since k and Linf are negatively correlated. So, while the shape of the curve might be the same, the estimated values may be different depending on the model structure used and whether you are estimating both parameters simultaneously or fixing one while estimating the other.

**Now, to think about diet compositions**

I binned the lengths into 5cm bins and looked at the diet fraction that is sebastes between male and female for lingcod caught off California ports and then lingcod caught from all ports.

```{r diet comps CA, echo=FALSE, message = FALSE}
load(file = "cleaned_data/lingcod_rockfish_CA.Rdata")
bins <- seq((min(lingcod_rockfish_CA$TL.cm)-2), (max(lingcod_rockfish_CA$TL.cm)+3), by=5)
TL.cm <- as.numeric(lingcod_rockfish_CA$TL.cm)
labels <- bins
rangelabels <- paste(head(labels,-1), tail(labels,-1), sep="-")
lingcod_rockfish_CA$Bin <- cut(TL.cm, bins, rangelabels)

ggplot(lingcod_rockfish_CA, aes(x = Bin, y = gut.ratio.sebastes.wt, color = Sex)) +
  geom_point() +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "length bins (cm)", y = "Diet fraction that is Sebastes", main = "CA only")

lingcod_rockfish_CA %>% 
  group_by(Sex) %>% 
  summarise(n=n())
```

```{r diet comps all, echo=FALSE, message = FALSE}
bins_full <- seq((min(lingcod_rockfish$TL.cm)-2), (max(lingcod_rockfish$TL.cm)), by=5)
TL.cm_full <- as.numeric(lingcod_rockfish$TL.cm)
labels_full <- bins_full
rangelabels_full <- paste(head(labels_full,-1), tail(labels_full,-1), sep="-")
lingcod_rockfish$Bin <- cut(TL.cm_full, bins_full, rangelabels_full)

ggplot(lingcod_rockfish, aes(x = Bin, y = gut.ratio.sebastes.wt, color = Sex)) +
  geom_point() +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "length bins (cm)", y = "Diet fraction that is Sebastes", main = "All ports")

lingcod_rockfish %>% 
  group_by(Sex) %>% 
  summarise(n=n())
```

Bonnie et al. found that there was little difference in the scorpaenidae percent abundance by weight between male and females but this is not considering size.

![Figure from Bonnie et al.](July_images/percent.abundance.w.png){height="50%"}

To do next week:\
- plot age error on y axis and lengths/age on x axis to better visualize the bias in predicted age vs observed age\
- In the diet composition plot, should plot a weighted average by stomach mass (a fish that ate a little might not be considered equal to a fish that ate a lot). Also plot an average to compare. So, there should be 1 data point per bin. Make circle sizes based on sample size.\
- Identify a cutoff for older ages to develop a diet composition "plus group" since we don't have much data. This is to set all diet fractions above a certain age to a single value. Use diet composition plot and mess around with bin size to help visualize a cutoff.

### July 8, 2021

I found a package (AquaticLifeHistory) from <https://github.com/jonathansmart/AquaticLifeHistory> that will perform length-at-age analyses using a von Bertalanffy growth model, Gompertz model and/or Logistic model (Smart et al. (2016)). I ran the package on the data that I have and the von Bertallanfy growth model was the best fit of the 3 models for both sexes, so I run only this model below

Female -

```{r growthpkg female, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}
load(file = "cleaned_data/lingcod_full.Rdata")
library(AquaticLifeHistory)
growth_data = lingcod_full %>% 
  select(Ages, TL.cm, Sex)
colnames(growth_data) = c("Age", "Length", "Sex")
growth_data_F = growth_data %>% 
  filter(Sex == "F")
growth_data_M = growth_data %>% 
  filter(Sex == "M")
Estimate_Growth(growth_data_F, models = c("VB"))
```

Male -

```{r growthpkg male, echo = FALSE, warning = FALSE, message = FALSE, eval = FALSE}
Estimate_Growth(growth_data_M, models = c("VB"))
```

and here is a graph of the error in predicted ages compared to observed ages. The error is pretty large between lengths 75-110 (red dotted line). This is because there are some pretty fast growing individuals in lower age classes that the predictions don't capture. The second graph shows how many ages need to be predicted for a given length. There's a good amount of ages to be predicted that fall within the lengths that have large error, but it doesn't seem to be the majority which might be fine?.

```{r errorgrowth, echo = FALSE, warning = FALSE, message = FALSE}
ggplot(lingcod_full_with_age, aes(TL.cm, age_error, color = Sex)) +
  geom_point() +
  theme_classic() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = c(70,110), linetype='dotted', col = 'red') +
  labs(y = "Error", x = "Length (cm)", title = "Error in Predicted Lengths")

age_NA <- lingcod_full_with_age[is.na(lingcod_full_with_age$Ages),]

# histogram of lengths that need age predictions
ggplot(age_NA, aes(TL.cm)) +
  geom_histogram() +
  theme_classic() +
  geom_vline(xintercept = c(70,110), linetype='dotted', col = 'red') +
  labs(title = "Lengths to be predicted", x = "Length (cm)")
```

I've also created Age-Length Keys for both male and female, and I'm still trying to figure out how to use that to understand the distribution of lengths for a given age or the distribution of ages for a given length. The distribution depends on whether this data was collected length-based sampling (distribution of age at a given length) vs age-based sampling (distribution of length at given length). Seems most of these data are collected by length-based sampling, so the way to avoid violating the assumption of length-based sampling to to treat them as a distribution of ages for each length interval (random-at-length/conditional age-at-length)

Conditional age-at-length (distribution of age given length) more robust information on variability in growth compared to distribution of length at given age.

But...\
"The expectation of a growth model estimated using random-at-length observations (length-conditional method/conditional age-at-length) requires a measure of the population age structure...Because of the need to know the population age--structure from which the samples were taken, the use of the length-conditional approach has been confined within the population dynamics model"

BUT... There is an "approximate length-conditional" approach from Piner et al. 2015 independent of the stock assessment/population model based on an equilibrium population age structure

**Diet Composition**

I calculated the weighted mean by grouping the data by Sex and length bins. Then within these groups, I determined the weighting by taking each individuals stomach content divided by the total stomach content of that Sex x Length bin grouping. So, individuals of a given Sex x length bin that ate a lot compared to others in the Sex x Length bin group were weighted higher.

![All Ports](July_images/dietcomp_AllPorts.jpeg)

![California Ports only](July_images/dietcomp_CAonly.jpeg)

Would it be appropriate to just try to fit a logistic curve into this and use that for the vector of diet compositions (after converting length bins to ages)?

**Extra NRT funds**

I have \$5000 that I must use before Aug. 2023 during any quarter (including summer) to cover time and travel related to the program. There is already money set aside for conference travel as well as presenting at a CSU. So, maybe I can use these funds for going to fisheries-related workshops, meetings (PFMC?), short courses? I do have stipend funding through Aug. 2023 through NRT and then GGE Fellowship. Does that GGE Fellowship prevent me from using these funds while I'm on it?

"Once we have your application, we will send out an email to you and your advisor with the account number to bill for these funds"

To do next week:\
- Fit a Gam curve into diet composition.\
- Thought: what we'll have is consumption rate per individual (each individual is eating this much food) multiply that by whatever fraction of diet is rockfish. Should it be weighted or not?\
- Think about how to use NRT funds

### July 15, 2021

I fit some GAMs on the male and female un-weighted means for Total Length bin sizes of 8 using `gam()` in the `mgcv` package. For females, the gam fit with wiggliness and looks fine. I used "REML" method. But for males, the outlier at the lower bin length is making the fit just a linear regression (edf = 1) with really poor fit. When I remove the outlier, the fit looks similar to the females and theres a better fit ($r^2$). Graphed here is when the outlier is removed for males. First graph is females and next graph is males.

```{r GAMs, echo = FALSE, warning = FALSE, message = FALSE}
library(gridExtra)
library(mgcv)

# We'll go ahead and just use the dataset with all of the ports included.
df <- miceadds::load.Rdata2(filename="cleaned_data/lingcod_rockfish.Rdata")

# Dataframe with the average diet fraction by weight that is sebastes for each age and sex 
dietfrac_by_age_wt <- df %>% 
  group_by(Sex, age_useful) %>% 
  summarise(mean = mean(gut.ratio.sebastes.wt), sd = sd(gut.ratio.sebastes.wt), 
            n = n(), max = max(gut.ratio.sebastes.wt), min = min(gut.ratio.sebastes.wt))
dietfrac_by_age_wt$sd[is.na(dietfrac_by_age_wt$sd)] <- 0

# Set up bin size
bin_size = 8
round_to = 10

# Create length bins
bins <- seq(plyr::round_any(min(df$TL.cm), round_to, f = floor), plyr::round_any(max(df$TL.cm), round_to, f = ceiling), by= bin_size)
TL.cm <- as.numeric(df$TL.cm)
rangelabels <- paste(head(bins,-1), tail(bins,-1), sep="-")
df$Bin <- cut(TL.cm, bins, rangelabels)

# Let's add a grouped sum by age and sex to do our weightings
gut_summary = df %>% 
  group_by(Sex, Bin) %>% 
  summarise(mean = mean(gut.ratio.sebastes.wt), 
            sd = sd(gut.ratio.sebastes.wt),
            gut_sum_by_sex.lengthbin = sum(wt..Total),
            n = n())
gut_summary$sd[is.na(gut_summary$sd)] <- 0
gut_summary_sum = gut_summary %>% 
  select(Sex, Bin, gut_sum_by_sex.lengthbin)
# now add back to dataset
df = left_join(df, gut_summary_sum, by = c("Sex", "Bin"))

df$gut.weighting = df$wt..Total/df$gut_sum_by_sex.lengthbin

gut_summary = df %>% 
  group_by(Sex, Bin) %>% 
  summarise(mean = mean(gut.ratio.sebastes.wt), 
            sd = sd(gut.ratio.sebastes.wt),
            weightedmean = weighted.mean(gut.ratio.sebastes.wt, gut.weighting),
            gutsumcheck = sum(gut.weighting),
            n = n())
gut_summary[is.na(gut_summary)] = 0

# must convert bin from categorical to numerical since gams need numerical values.
gut_summary$Bin = gsub("\\-.*","\\", gut_summary$Bin)
gut_summary$Bin = as.numeric(gut_summary$Bin) + 0.5*bin_size # Set bin column to be the midpoint of each bin

# female
diet_f = as.data.frame(gut_summary) %>% 
  filter(Sex == "F") 
diet_model_f = gam(mean ~ s(Bin), data = diet_f, method = "REML")
plot(diet_model_f,pages=1,residuals=TRUE,all.terms=TRUE,shade=TRUE,shade.col=2)
summary(diet_model_f)

#male
diet_m = as.data.frame(gut_summary) %>% 
  filter(Sex == "M") %>% 
  filter(mean < .24) # removed the outlier
diet_model_m = gam(mean ~ s(Bin), data = diet_m, method = "ML")
plot(diet_model_m,pages=1, residuals=TRUE,all.terms=TRUE,shade=TRUE,shade.col=2)
summary(diet_model_m)
```

But when the outlier is included, the gam looks like this:

![male GAM w/ outlier](July_images/male_gam_w_outlier.jpeg)

When using weighted means, the model also reduces to a linear model for both males and females.

I then predict the diet composition using the gam model for the lengths at age in my population model. Female first and then male

```{r gam predict, echo = FALSE, warning = FALSE, message = FALSE}
load(file = "cleaned_data/lingcod_parms.Rdata")
lingcod_female = as.data.frame(lingcod$length.at.age["female",])
colnames(lingcod_female) = "Bin"
diet_comp_f = predict.gam(diet_model_f, lingcod_female)

lingcod_male = as.data.frame(lingcod$length.at.age["male",])
colnames(lingcod_male) = "Bin"
diet_comp_m = predict.gam(diet_model_m, lingcod_male)

plot(diet_comp_f)
plot(diet_comp_m)
```

My growth curve uses the externally estimated parameters rather than the internally estimated parameters since I can't find those numbers in the stock assessment (they only provide the plot of the curve). The female diet composition doesn't curve back down because my population model length at max age (20) is about 95cm, while the gam model predictions go up to about 120cm.

Something to think about: For the diet composition data, I estimated age using the lingcod diet data from Bonnie et al. which had length measurements of all the individuals and a subsample of age estimates. However, these growth parameter estimates are different than the ones I am using for the population model. For the population model, I am using externally estimated parameters from the 2017 stock assessment. Because my diet composition vector is predicted by length (bins), is it fine that the length-age estimates don't align?

### July 22, 2021

I gave *Moriarty et. al (2017)*'s diet fraction estimation method a try. Her approach estimates diet fraction for all ages aggregated. However, I want a vector of diet fractions given an age [1:20]. First, I want to create length intervals for a given age so that I can maximize the data being used to calculate diet fractions. I estimate this interval using the age-length keys that I developed from the diet data. I did a quick check to see how well the growth curve estimated from the diet data matches the growth curve being used in the stock assessment so that there aren't any biases.

![female age-length key](July_images/female_growth_curve.jpeg)

![male age-length key](July_images/male_growth_curves.jpeg)


and it looks like the match pretty well, so I am going to go ahead and use the age-length key to determine length intervals for each age.